<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>R on Guy Abel</title>
    <link>/categories/r/</link>
    <description>Recent content in R on Guy Abel</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-uk</language>
    <copyright>&amp;copy; 2021 &amp;middot; Selected posts also on &lt;a href=&#34;https://r-bloggers.com/&#34;&gt;R-bloggers&lt;/a&gt;</copyright>
    <lastBuildDate>Fri, 21 May 2021 00:00:00 +0000</lastBuildDate>
    <atom:link href="/categories/r/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Animated Sankey Plots of Global Migrant Populations</title>
      <link>/post/animated-sankey/</link>
      <pubDate>Fri, 21 May 2021 00:00:00 +0000</pubDate>
      
      <guid>/post/animated-sankey/</guid>
      <description>
&lt;script src=&#34;../../rmarkdown-libs/header-attrs/header-attrs.js&#34;&gt;&lt;/script&gt;
&lt;link href=&#34;../../rmarkdown-libs/anchor-sections/anchor-sections.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;../../rmarkdown-libs/anchor-sections/anchor-sections.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;background&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Background&lt;/h2&gt;
&lt;p&gt;Sankey plots have been used to visualize bilateral migration many times. My favorite examples of Sankey plots for migration data tend to be when there are only few regions or countries. As the number of regions or countries increases the plot become more cumbersome, where labels for the smaller areas get too small and the plotting area becomes a very long rectangle making it awkward to fit on paper or view on the screen. In such cases I prefer &lt;a href=&#34;https://guyabel.com/post/global-migrant-stocks/&#34;&gt;chord diagrams&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The recent highlights &lt;a href=&#34;https://www.un.org/development/desa/pd/sites/www.un.org.development.desa.pd/files/undesa_pd_2020_international_migration_highlights.pdf&#34;&gt;document&lt;/a&gt; for the UN international migration stock data contained a couple of Sankey plots for the data in 2020. In this post I have created animated versions of one of the plots in the report to show changes in migrant distributions between 1990 and 2020 by World Bank income groups. I am using the destination and origin migrant stock data of the UN that can found online &lt;a href=&#34;https://www.un.org/development/desa/pd/content/international-migrant-stock&#34;&gt;here&lt;/a&gt; - see the data links on the right hand side.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;r-code&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;R Code&lt;/h2&gt;
&lt;p&gt;Commented code to create the animated plots below are in a Gist &lt;a href=&#34;https://gist.github.com/guyabel/f7c844f18c4d11916a6ee000532d0e8e&#34;&gt;here&lt;/a&gt;, which you can run in R using the following…&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(devtools)
source_gist(&amp;quot;https://gist.github.com/guyabel/f7c844f18c4d11916a6ee000532d0e8e&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;…so long as you have installed all packages used in the script. You might also need to edit the &lt;code&gt;saveVideo()&lt;/code&gt; function for the location of &lt;code&gt;ffmpeg.exe&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The first part of the code imports the data into R, extracts the rows for the stock data by the World Bank income groups and creates a tweened data set for each frame of the animation.&lt;/p&gt;
&lt;p&gt;The second part of the code creates the animated plot file using ggplot and &lt;code&gt;geom_parallel_sets()&lt;/code&gt; in &lt;a href=&#34;https://ggforce.data-imaginist.com/reference/geom_parallel_sets.html&#34;&gt;ggforce&lt;/a&gt;. There are a few packages in R that have functions for Sankey plots, for example &lt;a href=&#34;https://github.com/gaborcsardi/sankey#readme&#34;&gt;sankey&lt;/a&gt;, &lt;a href=&#34;https://cran.r-project.org/web/packages/PantaRhei/vignettes/panta-rhei.html&#34;&gt;PantaRhei&lt;/a&gt;, &lt;a href=&#34;http://christophergandrud.github.io/networkD3/#sankey&#34;&gt;networkD3&lt;/a&gt;, &lt;a href=&#34;https://cran.rstudio.com/web/packages/sankeywheel/vignettes/sankeywheel.html&#34;&gt;sankeywheel&lt;/a&gt;, &lt;a href=&#34;https://plotly.com/r/sankey-diagram/&#34;&gt;plotly&lt;/a&gt; and &lt;a href=&#34;https://github.com/davidsjoberg/ggsankey&#34;&gt;ggsankey&lt;/a&gt;. The &lt;a href=&#34;https://corybrunson.github.io/ggalluvial/&#34;&gt;ggalluvial&lt;/a&gt; packages also produces Sankey-type plots, but without spaces between each sector. I used ggforce because it is pretty easy to tweak the non-Sankey parts of the plot using ggplot functions, and I had hoped that it would play well with gganimate - which it didn’t, hence the use of tweenr - but perhaps &lt;a href=&#34;https://github.com/thomasp85/ggforce/issues/235&#34;&gt;one day&lt;/a&gt; it will given Thomas Lin Pedersen developed both the gganimate and ggforce packages.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;plots&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Plots&lt;/h2&gt;
&lt;p&gt;The first animated plot shows the changes over time where the y-axis increases as the migrant populations grow larger. It shows the evolution in the relative distributions of the origin, destination and the linking migrant corridors, in particular the relative growth of migrants in high income countries.&lt;/p&gt;
&lt;style&gt;
.carousel-indicators {
  bottom:-10px
}

.carousel {
   margin-top:-1%;
}

.carousel-indicators &gt; li,
.carousel-indicators &gt; li.active{
    width: 40%;
    height: 2%;
    border-radius: 0;
    border: solid 1px grey;
    background: white;
    text-indent: 0;
}
.carousel-indicators &gt; li.active {
    background: #4caf50;
}
&lt;/style&gt;
&lt;div id=&#34;carousel_free&#34; class=&#34;carousel slide&#34;&gt;
&lt;!-- Indicators --&gt;
&lt;ol class=&#34;carousel-indicators&#34;&gt;
&lt;li data-target=&#34;#carousel_free&#34; data-slide-to=&#34;0&#34; class=&#34;active&#34;&gt;
Known Origins
&lt;/li&gt;
&lt;li data-target=&#34;#carousel_free&#34; data-slide-to=&#34;1&#34;&gt;
All Origins
&lt;/li&gt;
&lt;/ol&gt;
&lt;!-- Wrapper for slides --&gt;
&lt;div class=&#34;carousel-inner&#34;&gt;
&lt;div class=&#34;item active&#34;&gt;
&lt;video loop=&#34;loop&#34; width=&#34;720&#34; height=&#34;720&#34; controls&gt;
&lt;source src=&#34;../../img/sankey-income/abel-free.mp4&#34; type=&#34;video/mp4&#34; /&gt;
&lt;/video&gt;
&lt;/div&gt;
&lt;div class=&#34;item&#34;&gt;
&lt;video loop=&#34;loop&#34; width=&#34;720&#34; height=&#34;720&#34; controls&gt;
&lt;source src=&#34;../../img/sankey-income/abel-free-unknown.mp4&#34; type=&#34;video/mp4&#34; /&gt;
&lt;/video&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;Note: you might have to right click, select show controls and hit play to start the animations depending on your browsers - right clicking can also allow you to access controls on the play back speed and save the video if you want to use it elsewhere.&lt;/p&gt;
&lt;p&gt;The second animated plot shows the changes over time where the y-axis is fixed to its maximum level. The adjustment allows the Sankey to grow into the plot space to see more clearly the changes in the overall levels of migrant populations.&lt;/p&gt;
&lt;div id=&#34;carousel_fixed&#34; class=&#34;carousel slide&#34;&gt;
&lt;!-- Indicators --&gt;
&lt;ol class=&#34;carousel-indicators&#34;&gt;
&lt;li data-target=&#34;#carousel_fixed&#34; data-slide-to=&#34;0&#34; class=&#34;active&#34;&gt;
Known Origins
&lt;/li&gt;
&lt;li data-target=&#34;#carousel_fixed&#34; data-slide-to=&#34;1&#34;&gt;
All Origins
&lt;/li&gt;
&lt;/ol&gt;
&lt;!-- Wrapper for slides --&gt;
&lt;div class=&#34;carousel-inner&#34;&gt;
&lt;div class=&#34;item active&#34;&gt;
&lt;video loop=&#34;loop&#34; width=&#34;720&#34; height=&#34;720&#34; controls&gt;
&lt;source src=&#34;../../img/sankey-income/abel-fixed.mp4&#34; type=&#34;video/mp4&#34; /&gt;
&lt;/video&gt;
&lt;/div&gt;
&lt;div class=&#34;item&#34;&gt;
&lt;video loop=&#34;loop&#34; width=&#34;720&#34; height=&#34;720&#34; controls&gt;
&lt;source src=&#34;../../img/sankey-income/abel-fixed-unknown.mp4&#34; type=&#34;video/mp4&#34; /&gt;
&lt;/video&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;For both plots above there are alternative versions, that include an additional origin category for unknown place of birth. The values for the stock of migrants with unknown origins living in each World Bank income group are not in the main data frame in the UN excel sheet, but are in the regional aggregate sheets for each period. As a result the data importing and manipulation takes a bit of extra work (it is commented out in the Gist R script), but the plots are more ‘complete’, where the totals of the sectors sum to the global estimate of the UN at each time point.&lt;/p&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Expand broom::tidy() output for categorical parameter estimates</title>
      <link>/post/tidycat/</link>
      <pubDate>Wed, 08 Jul 2020 00:00:00 +0000</pubDate>
      
      <guid>/post/tidycat/</guid>
      <description>


&lt;div&gt;
&lt;img src=&#34;../../img/tidycat.png&#34; width=&#34;200px&#34; align=&#34;right&#34;&gt;
&lt;/div&gt;
&lt;div id=&#34;introduction&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;tidycat&lt;/code&gt; package includes the &lt;code&gt;tidy_categorical()&lt;/code&gt; function to expand &lt;code&gt;broom::tidy()&lt;/code&gt; outputs for categorical parameter estimates.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;documentation&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Documentation&lt;/h2&gt;
&lt;p&gt;For full documentation, see the package vignette: &lt;a href=&#34;https://cran.r-project.org/web/packages/tidycat/vignettes/intro.html&#34;&gt;The tidycat package: expand broom::tidy() output for categorical parameter estimates&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;hello-world&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Hello World&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;tidy()&lt;/code&gt; function in the broom package takes the messy output of built-in functions in R, such as &lt;code&gt;lm()&lt;/code&gt;, and turns them into tidy data frames.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(dplyr)
library(broom)

m1 &amp;lt;- mtcars %&amp;gt;%
  mutate(transmission = recode_factor(am, `0` = &amp;quot;automatic&amp;quot;, `1` = &amp;quot;manual&amp;quot;)) %&amp;gt;%
  lm(mpg ~ transmission + wt *  as.factor(cyl), data = .)

tidy(m1)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 7 x 5
##   term               estimate std.error statistic       p.value
##   &amp;lt;chr&amp;gt;                 &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt;         &amp;lt;dbl&amp;gt;
## 1 (Intercept)          41.5        4.54     9.14  0.00000000190
## 2 transmissionmanual   -0.902      1.51    -0.595 0.557        
## 3 wt                   -6.19       1.65    -3.75  0.000937     
## 4 as.factor(cyl)6      -8.66      10.4     -0.836 0.411        
## 5 as.factor(cyl)8     -16.9        5.27    -3.20  0.00374      
## 6 wt:as.factor(cyl)6    2.12       3.40     0.625 0.538        
## 7 wt:as.factor(cyl)8    3.84       1.77     2.17  0.0399&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The &lt;code&gt;tidy_categorical()&lt;/code&gt; function adds&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;further columns (&lt;code&gt;variable&lt;/code&gt;, &lt;code&gt;level&lt;/code&gt; and &lt;code&gt;effect&lt;/code&gt;) to the &lt;code&gt;broom::tidy()&lt;/code&gt; output to help manage categorical variables&lt;/li&gt;
&lt;li&gt;further rows for reference category terms and a column to indicate their location (&lt;code&gt;reference&lt;/code&gt;) when setting &lt;code&gt;include_reference = TRUE&lt;/code&gt; (default)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It requires two inputs&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a data frame &lt;code&gt;d&lt;/code&gt; of parameter estimates from a model from &lt;code&gt;broom::tidy()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;the corresponding model object &lt;code&gt;m&lt;/code&gt; passed to &lt;code&gt;broom::tidy()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(tidycat)
d1 &amp;lt;- m1 %&amp;gt;%
  tidy(conf.int = TRUE) %&amp;gt;%
  tidy_categorical(m = m1)
d1 %&amp;gt;%
  select(-(3:5))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 10 x 8
##    term      estimate conf.low conf.high variable    level  effect  reference   
##    &amp;lt;chr&amp;gt;        &amp;lt;dbl&amp;gt;    &amp;lt;dbl&amp;gt;     &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;       &amp;lt;fct&amp;gt;  &amp;lt;chr&amp;gt;   &amp;lt;chr&amp;gt;       
##  1 (Interce~   41.5     32.1       50.8  (Intercept) (Inte~ main    Non-Baselin~
##  2 &amp;lt;NA&amp;gt;         0        0          0    transmissi~ autom~ main    Baseline Ca~
##  3 transmis~   -0.902   -4.02       2.22 transmissi~ manual main    Non-Baselin~
##  4 wt          -6.19    -9.59      -2.79 wt          wt     main    Non-Baselin~
##  5 &amp;lt;NA&amp;gt;         0        0          0    as.factor(~ 4      main    Baseline Ca~
##  6 as.facto~   -8.66   -30.0       12.7  as.factor(~ 6      main    Non-Baselin~
##  7 as.facto~  -16.9    -27.7       -6.00 as.factor(~ 8      main    Non-Baselin~
##  8 &amp;lt;NA&amp;gt;         0        0          0    wt:as.fact~ 4      intera~ Baseline Ca~
##  9 wt:as.fa~    2.12    -4.87       9.12 wt:as.fact~ 6      intera~ Non-Baselin~
## 10 wt:as.fa~    3.84     0.192      7.50 wt:as.fact~ 8      intera~ Non-Baselin~&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The expanded data frame from &lt;code&gt;tidy_categorical()&lt;/code&gt; of parameter estimates can be particularly useful for creating coefficient plots, allowing:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;grouping terms from the same categorical variable from the additional columns.&lt;/li&gt;
&lt;li&gt;inclusion of reference categories in a coefficient plot from the additional rows, allowing the reader to better grasp the meaning of the parameter estimates in each categorical variable.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(forcats)
library(ggplot2)
library(ggforce)

d1 %&amp;gt;%
  slice(-1) %&amp;gt;%
  mutate(variable = fct_inorder(variable)) %&amp;gt;%
  ggplot(mapping = aes(x = level, y = estimate, colour = reference,
                       ymin = conf.low, ymax = conf.high)) +
  facet_row(facets = &amp;quot;variable&amp;quot;, scales = &amp;quot;free_x&amp;quot;, space = &amp;quot;free&amp;quot;) +
  geom_hline(yintercept = 0, linetype = &amp;quot;dashed&amp;quot;) +
  geom_pointrange()&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../post/tidycat_files/figure-html/unnamed-chunk-3-1.png&#34; width=&#34;768&#34; /&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;installation&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;You can install the released version of tidycat from &lt;a href=&#34;https://CRAN.R-project.org&#34;&gt;CRAN&lt;/a&gt; with:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;install.packages(&amp;quot;tidycat&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And the development version from &lt;a href=&#34;https://github.com/&#34;&gt;GitHub&lt;/a&gt; with:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# install.packages(&amp;quot;devtools&amp;quot;)
devtools::install_github(&amp;quot;guyabel/tidycat&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>
